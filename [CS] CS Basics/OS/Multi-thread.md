# Multi-thread

멀티 스레딩을 시작하기 전에..

<br>

### 복습! Process vs. Thread

- 수민 님이 발표하신 [Process와 Thread의 차이](1.Process와Thread차이.md)

![views](https://wayhome25.github.io/assets/post-img/cs/thread.png)

<br>

#### 프로세스 (Process)

- 실행 중인 프로그램으로, 디스크로부터 메모리에 적재되어 운영체제로부터 주소 공간, 파일, 메모리 등을 할당 받음
- 함수의 매개변수, 복귀 주소, 로컬 변수와 같은 임시 자료를 저장하는 프로세스 스택과 전역 변수들을 저장하는 데이터 섹션, 프로세스 실행 중에 동적으로 할당되는 메모리인 힙을 포함
- 특정 프로세스에 대한 중요한 정보를 저장하고 있는 운영체제의 자료구조를 PCB(Process Control Block)라고 하며, 운영체제는 프로세스의 생성과 동시에 고유한 PCB를 생성하여 프로세스를 관리

<br>

#### 스레드 (Thread)

- 프로세스의 실행 단위. 한 프로세스 내에서 동작되는 여러 실행 흐름으로 프로세스 내의 Heap, Data, Code 영역을 공유
- 각각의 스레드는 독립적인 작업을 수행해야 하기 때문에 각자의 스택과 PC 레지스터 값을 가지고 있음

> [참고] 스택을 스레드마다 독립적으로 할당하는 이유
>
> 스택은 함수 호출 시 전달되는 인자, 되돌아 갈 주소값 및 함수 내에서 선언하는 변수 등을 저장하기 위해 사용되는 메모리 공간이다. 스택 메모리 공간이 독립적이라는 것은 독립적인 함수 호출이 가능하다는 것이다. 스레드의 정의에 따라 독립적인 실행 흐름을 가지기 위한 최소 조건으로 독립된 스택을 할당한다.

<br><br>

## 멀티 스레딩(Multi-threading)이란?

![img](https://t1.daumcdn.net/cfile/tistory/995444505AD60F8314)

- 하나의 프로세스를 다수의 실행 단위로 구분하여 자원을 공유하고 자원의 생성과 관리의 중복성을 최소화하여 수행 능력을 향상 시키는 것
- 하나의 프로그램에서 동시에 여러 개의 일을 수행할 수 있도록 해줌 (사실 분산처리를 통해 동시에 실행되는 것 처럼 보이는 것)<br>ex) 워드 프로세서에서 그림을 표시하고, 키 입력에 응답하며 철자 및 문법 검사를 계속 함
  ![멀티 스레딩](http://techdifferences.com/wp-content/uploads/2017/01/multithreading.jpg)

<br><br>

## 멀티 스레딩의 장점과 단점

<br>

### 장점

1. **응답성** : 프로그램의 일부분(스레드)이 중단되거나 긴 작업을 수행하더라도 프로그램의 수행이 계속 되어 사용자에 대한 응답성이 증가한다.<br>
   ex) 멀티 스레드가 적용된 웹 브라우저 프로그램에서 하나의 스레드가 이미지 파일을 로드하고 있는 동안, 다른 스레드에서 사용자와 상호작용 가능
2. **경제성** : 프로세스 내 자원들과 메모리를 공유하기 때문에 메모리 공간과 시스템 자원 소모가 줄어든다. 스레드 간 통신이 필요한 경우에도 쉽게 데이터를 주고 받을 수 있으며, 프로세스의 context switching과 달리 스레드 간의 context switching은 캐시 메모리를 비울 필요가 없기 때문에 더 빠르다.
3. **멀티프로세서 활용** : 다중 CPU 구조에서는 각각의 스레드가 다른 프로세서에서 병렬로 수행될 수 있으므로 병렬성이 증가한다.

<br>

### 단점

- **임계 영역(Critical Section)?** 둘 이상의 스레드가 동시에 실행하면 문제를 일으키는 코드 블록. 공유하는 자원에 동시에 접근하는 경우, 프로세스와는 달리 스레드는 데이터와 힙 영역을 공유하기 때문에 어떤 스레드가 다른 스레드에서 사용 중인 변수나 자료구조에 접근하여 엉뚱한 값을 읽어오거나 수정할 수 있다. 따라서 동기화가 필요!
- 동기화를 통해 스레드의 작업 처리 순서와 공유 자원에 대한 접근을 컨트롤할 수 있다. (Java에서 `synchronized` 키워드) 그러나 불필요한 부분까지 동기화를 하는 경우, 과도한 lock으로 인해 병목 현상을 발생시켜 성능이 저하될 가능성이 높기 때문에 주의해야 한다. 동기화 방법에는 뮤텍스와 세마포어가 있다. (다음에 언젠가! *To be continued..*)
- context switching, 동기화 등의 이유 때문에 싱글 코어 멀티 스레딩은 스레드 생성 시간이 오히려 오버헤드로 작용해 단일 스레드보다 느리다.

<br><br>

## 멀티 프로세스와 멀티 스레드

- 동시에 두 가지 이상의 루틴을 실행할 수 있는 역할을 하는 것은 동일

<br>

### 멀티 프로세스 (Multi-process)

![img](https://t1.daumcdn.net/cfile/tistory/230A334B5822F74D08)

- fork를 통해 프로세스를 복사할 수 있는데, 부모-자식 관계라고 해도 환경변수와 프로세스 핸들 테이블이 상속 가능할 뿐, 자신만의 메모리 영역을 가진다.
- 프로세스 간 통신을 하려면 IPC(Inter Process Communication)를 통해야 한다.

<br>

### 멀티 스레드 (Multi-thread)

![img](https://t1.daumcdn.net/cfile/tistory/217D00505822F78905)

- 단일 프로세스의 컨텍스트 내에서 여러 스레드를 동시에 실행하는 것.
- 한 프로세스 내의 스레드들은 Code, Data, Heap 영역을 공유한다.

<br><br>

## Reference

[위키백과 - 멀티스레딩](https://ko.wikipedia.org/wiki/멀티스레딩)

[Xeros Security Lab - 멀티 쓰레딩과 멀티 프로세싱의 차이](https://xeros.dev/63)

[GoodGid Github - 멀티쓰레드(Multi Thread)란 무엇인가?](https://goodgid.github.io/What-is-Multi-Thread)

[Dvine - Multi Process VS Multi Thread 다중 스레드](https://divineprocess.tistory.com/entry/Multi-Thread-구축)
