#  Cache

책이 많이 있는 도서실에서 참고 자료를 찾아보며 글을 쓰는 상황을 생각해보자. 책이 책꽂이에 잘 정리되어 있기는 하지만, 책상에 앉아서 글을 쓰다가 책꽂이에 가서 필요한 책을 찾아오는 데는 꽤 시간이 걸린다. 따라서 무언가 참고할 것이 있어서 책을 한번 찾아오면, 필요한 내용을 본 뒤에 바로 책꽂이에 다시 갖다 꽂지 않고 책상 위에 놓아두는 것이 훨씬 편리하다. 잠시 후 같은 책을 다시 참고할 일이 생길 가능성이 크기 때문이다. 물론 책상의 넓이가 한정되어 있기 때문에 무한정 책을 가져다 놓을 수는 없다. 책상이 너무 비좁아지면 앞으로 비교적 덜 필요할 것 같은 책은 다시 책꽂이에 갖다둬야 한다.

눈치챘겠지만, 해당 상황에서 책상은 캐쉬, 책꽂이는 하드디스크라고 생각할 수 있다. 여기서 주목해야 할 사실이 있다. 첫째로 책꽂이와 책상이라는, 성격이 다른 두 가지 저장 장소가 있다는 점이다. 책꽂이는 용량이 큰 대신 시간이 많이 걸리고, 책상은 빨리 찾아볼 수 있는 대신 용량이 작다. 둘째는 한번 본 책은 앞으로 다시 보게 될 가능성이 크다는 점이다. 만약 그렇지 않다면 한번 본 책을 책상 위에 놓아 둘 필요는 없는 것이다.

<p><div align="center"><img src="https://upload.wikimedia.org/wikipedia/commons/6/62/Cachebasic_kor.PNG" align="center"></div></p>

하드웨어에서의 캐시 메모리는 <strong>속도가 빠른 장치와 느린 장치 간의 속도 차에 따른 병목 현상을 줄이기 위한 범용 메모리</strong>이다. 캐시의 접근 시간에 비해 원래 데이터를 접근하는 시간이 오래 걸리는 경우나 값을 다시 계산하는 시간을 절약하고 싶은 경우 사용한다.

<br>

> **[참고]** 메모리 계층 구조 (Memory Hierachy)
>
> 컴퓨터에 있는 여러 기억장치들도 그 속도와 용량이 각각 다르다. 하드디스크는 용량이 아주 크지만 속도가 느리고, 메인 메모리(RAM)의 용량은 하드디스크의 백 분의 1 정도로 작지만 속도는 십만 배 정도로 빠르다. 또 CPU에 들어 있는 캐시 메모리는(그냥 캐시라고 하면 보통 이것을 말한다) 메인 메모리의 백 분의 1 정도 용량이지만 속도는 훨씬 빠르다. 즉 기억장치들은 피라미드 모양의 계층 구조를 이루고 있어서, 위쪽은 용량이 작은 대신 속도가 크고, 아래쪽은 용량이 크면서 속도는 느리다.
> ![컴퓨터 구조 및 이해 2.메모리 시스템-기억장치 계층구조](https://img1.daumcdn.net/thumb/R720x0.q80/?scode=mtistory2&fname=http%3A%2F%2Fcfile2.uf.tistory.com%2Fimage%2F9986554C5C764825282457)

<br>

캐시와 메모리 데이터를 swap하여 필요 정보를 캐시에 저장시키는 기법을 사상(mapping)이라고 하는데, Direct Mapped, Fully Associative, Set Associative의 세가지 방식이 있다. 자세한 것은 [캐시 사상(mapping) 기법](http://blog.skby.net/%EC%BA%90%EC%8B%9C-%EC%82%AC%EC%83%81mapping-%EA%B8%B0%EB%B2%95) / [CPU 캐시 이해하기](https://aidanbae.github.io/code/devops/computer/cpucache) / [CPU 캐시의 원리](https://ezbeat.tistory.com/455) 블로그를 참고하도록 하자.

<br>

<br>

## Locality

캐시가 효율적으로 동작하려면, CPU가 어떤 데이터를 원할 것인가를 어느정도 예측할 수 있어야 한다. 캐시의 성능은 작은 용량의 메모리에 쓸모 있는 정보가 어느 정도 들어있느냐에 따라 좌우되기 때문이다.

CPU가 필요한 데이터가 캐시 내부에 있다면 `Hit`이라고 하고, 캐시 내부에 없다면 `Miss`라고 한다. 이 때 적중률(Hit ratio)을 극대화 시키기 위해 데이터 지역성의 원리를 사용한다.  이는 프로그램은 모든 코드나 데이터를 균등하게 Access하지 않는다는 특성을 전제로 한다. 즉, 지역성이란 데이터 접근이 시작적, 혹은 공간적으로 가깝게 일어나는 것을 의미한다. 데이터 지역성은 대표적으로 `시간 지역성(Temporal Locality)`과 `공간 지역성(Spatial Locality)`으로 나뉜다.

<br>

#### 시간 지역성 (Temporal Locality)

특정 데이터가 한번 접근되었을 경우, 가까운 미래에 또 한번 데이터에 접근할 가능성이 높은 것을 시간적 지역성이라고 한다. 즉, 최근에 참조된 주소의 내용은 곧 다음에 다시 참조되는 특성이라고 할 수 있다. 메모리 상의 같은 주소에 여러 차례 읽기 쓰기를 수행할 경우 상대적으로 작은 크기의 캐시를 사용해도 효율성을 꾀할 수 있다.

*ex) For, while 같은 반복문에 사용되는 조건 변수*

<br>

#### 공간 지역성 (Spatial Locality)

특정 데이터와 가까운 주소가 순서대로 접근되었을 경우를 공간적 지역성이라고 한다. 대부분의 실제 프로그램은 참조된 주소와 인접한 주소의 내용이 다시 참조되는 특성을 가지고 있다. 이 특성때문에 CPU 캐시나 디스크 캐시의 경우 한 메모리 주소에 접근할 때 그 주소뿐 아니라 해당 블록을 전부 캐시에 가져오게 된다. 이때 메모리 주소를 오름차순이나 내림차순으로 접근한다면, 캐시에 이미 저장된 같은 블록의 데이터를 접근하게 되므로 캐시의 효율성이 크게 향상된다.

*ex) a[0], a[1]처럼 배열의 연속적인 원소*

<br>

<br>

## Cache Line

캐시가 아무리 가까이 있더라도 찾고자 하는 데이터가 어느 곳에 저장되어 있는지 몰라 모든 데이터를 순회해야 한다면 시간이 오래 걸릴 것이다. 즉, 캐시에 목적 데이터가 저장되어 있다면 바로 접근하여 출력할 수 있어야 캐시가 의미 있어진다는 것이다. 

따라서 캐시에 저장하는 데이터에는 데이터의 메모리 주소 등을 기록해 둔 태그를 달아놓을 필요가 있다. 이러한 태그들의 묶음을 캐싱 라인이라고 하고 메모리로부터 가져올 때도 캐시 라인을 기준으로 가져온다. 캐시 라인은 일정한 크기의 block 단위로 관리된다. 일반적으로 32Byte ~ 256Byte 정도의 크기이다. 

<p><div align="center"><img src="https://t1.daumcdn.net/cfile/tistory/2265243D52070EDE1C" align="center"></div></p>

<br>

<br>

## + Web에서의 캐시

OS에서 뿐만 아니라, 웹에도 캐시가 존재한다. 캐시는 <strong>자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치</strong>다. 웹 요청이 캐시에 도착했을 때, 캐시된 로컬 사본이 존재한다면, 그 문서는 원서버가 아니라 캐시로부터 제공된다. 캐시의 장점은 아래와 같다.

- 불필요한 데이터 전송을 줄여서, **네트워크 요금으로 인한 비용을 줄여준다.**
- 캐시는 **네트워크 병목을 줄여준다.** 대역폭을 늘리지 않고도 페이지를 빨리 불러올 수 있게 된다.
- 캐시는 **원서버에 대한 요청을 줄여준다.** 서버는 부하를 줄일 수 있으며 더 빨리 응답할 수 있게 된다.
- 캐시는 **거리로 인한 지연을 줄여준다.** 페이지를 먼 곳에서 불러올수록 시간이 많이 걸린다.

해당 내용에 대한 자세한 사항은 [여기](https://feel5ny.github.io/2019/09/30/HTTP_007-1/)를 참고하면 된다.

<br>

<br>

## Reference

[위키피디아 - 캐시](https://ko.wikipedia.org/wiki/%EC%BA%90%EC%8B%9C)

[진보네트워크센터 - 캐시란 무엇인가](https://act.jinbo.net/wp/1066/)

