## DNS round robin 방식

서버 부하분산이란?
네트워크에서 발생되는 트래픽들이 일정량 이상으로 늘어나 한 서버에서 처리하기 힘들어 느린 반응속도, 서비스 다운 등 오류가 나기 쉬운데
이를 줄이기 위해 나온 대응 방안으로 초과되는 트래픽들을 여러 서버로 분산 처리하는 기술이다.
- L4
- DNS 라운드로빈
- OS 타입
- 어플라이언스 타입

### Round Robin이란?
Round Robin 방식이란 서버가 A, B, C 3대가 있다고 하면 첫번째 요청에는 A에 연결하여 주고 두번째 요청은 B에 연결하여 주고 세번째 요청은 C에 연결하여 주고 마지막으로 또다시 요청이 오면 A로 연결하여 주는 무한히 반복 연결하여 주는 방식이다.
하나의 도메인에 여러개의 IP주소를 등록해 요청 순서대로 각각 다른 IP주소로 보내, 각각 다른 서버로 접속시켜 부하를 분산하는 기술이다.
https://t1.daumcdn.net/cfile/tistory/250FD04554910AFA1C

### 과정
1. Dns Query
- 유저는 DNS 서버에서 도메인 이름을 이용하여, ip를 얻어온다.
- Domain Name Server는 접속하는 유저에 대해 Round Robin 식으로 ip를 할당한다.
https://media.vlpt.us/post-images/wmpark90/a87de520-1b09-11ea-9a4e-1945f8712967/image.png
2. 얻어온 ip를 이용한 통신
- 유저는 웹 페이지에 요청 및 응답한다.
https://media.vlpt.us/post-images/wmpark90/e3b24c30-1b09-11ea-b4c8-d5ec753f7f37/image.png

- 작동 예시
 www.test.com 에는 
	210.111.222.1
	210.111.222.2
	210.111.222.3 
	의 아이피3개가 설정되어있다.
	DNS서버는 해당 도메인 요청에 있을때 마다 아이피테이블의 순서를 바꾸어 대응한다. 
	A, B, C가 www.test.com을 순차적으로 들어왔다고 하자. 
	DNS서버는 
	A에게는 www.test.com의 아이피를 210.111.222.1 로 알려주고, 
	B에게는 210.111.222.2, 
	C에게는 210.111.222.3 으로 알려준다. 


### DNS Round Robin 방식의 문제점
1. 서버의 수 만큼 공인 IP 주소가 필요함
부하 분산을 위해 서버의 대수를 늘리기 위해서는 그 만큼의 공인 IP가 필요하다.

2. 균등하게 분산되지 않음
모바일 사이트 등에서 문제가 될 수 있는데, 스마트폰의 접속은 캐리어 게이트웨이 라고 하는 프록시 서버를 경유 한다.
프록시 서버에서는 이름변환 결과가 일정 시간 동안 캐싱되므로 같은 프록시 서버를 경유 하는 접속은 항상 같은 서버로 접속된다.
또한 PC용 웹 브라우저도 DNS 질의 결과를 캐싱하기 때문에 균등하게 부하분산 되지 않는다.
DNS 레코드의 TTL 값을 짧게 설정함으로써 어느 정도 해소가 되지만, TTL에 따라 캐시를 해제하는 것은 아니므로 반드시 주의가 필요하다.

3. 서버가 다운돼도 확인 불가
DNS 서버는 웹 서버의 부하나 접속 수 등의 상황에 따라 질의결과를 제어할 수 없다.
웹 서버의 부하가 높아서 응답이 느려지거나 접속수가 꽉 차서 접속을 처리할 수 없는 상황인 지를 전혀 감지할 수가 없기 때문에 어떤 원인으로 다운되더라도 이를 검출하지 못하고 유저들에게 제공한다.
이때문에 유저들은 간혹 다운된 서버로 연결이 되기도 한다. DNS 라운드 로빈은 어디까지나 부하분산 을 위한 방법이지 다중화 방법은 아니므로 다른 S/W와 조합해서 관리할 필요가 있다.

_Round Robin 방식을 기반으로 단점을 해소하는 DNS 스케줄링 알고리즘이 존재한다. (일부만 소개)_

#### weighted round-robin
각각의 웹 서버에 가중치를 가미해서 분산 비율을 변경한다.
물론 가중치가 큰 서버일수록 빈번하게 선택되므로 처리능력이 높은 서버는 가중치를 높게 설정하는 것이 좋다.

#### least-connection
접속 클라이언트 수가 가장 적은 서버를 선택한다.
로드밸런서에서 실시간으로 connection 수를 관리하거나 각 서버에서 주기적으로 알려주는 것이 필요하다.

#### weighted least-connection
lc와 같이만 가중치를 더한다.
구체적으로는 "(접속수+1)/가중치" 가 최소가 되는 서버를 선택하므로 처리능력이 높은 서버는 가중치를 크게 하는 것이 좋다.